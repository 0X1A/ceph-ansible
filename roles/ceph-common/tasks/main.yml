---
- name: Fail on unsupported system
  fail: "msg=System not supported {{ ansible_system }}"
  when: "ansible_system not in ['Linux']"

- name: Fail on unsupported architecture
  fail: "msg=Architecture not supported {{ ansible_architecture }}"
  when: "ansible_architecture not in ['x86_64']"

- name: Fail on unsupported distribution
  fail: "msg=Distribution not supported {{ ansible_os_family }}"
  when: "ansible_os_family not in ['Debian', 'RedHat']"

- name: Fail on wrong distribution with wrong repo
  fail: "msg=Inktank Ceph Enterprise can not be installed on {{ ansible_os_family }}, Red Hat Enterprise Linux 7 only"
  when: ansible_os_family == 'Debian' and ceph_stable_ice

- name: Fail on wrong distribution with wrong repo
  fail: "msg=Inktank Ceph Enterprise can not be installed on {{ ansible_os_family }}i {{ ansible_distribution_major_version }}, Red Hat Enterprise Linux 7 only"
  when: ansible_os_family == 'RedHat' and ansible_distribution_major_version != '7' and ceph_stable_ice

- include: install_on_redhat.yml
  when: ansible_os_family == 'RedHat'

- include: install_on_debian.yml
  when: ansible_os_family == 'Debian'

- name: Check for a Ceph socket
  shell: "stat /var/run/ceph/*.asok > /dev/null 2>&1"
  ignore_errors: true
  register: socket

- name: Generate cluster UUID
  shell: uuidgen | tee fetch/ceph_cluster_uuid.conf creates=fetch/ceph_cluster_uuid.conf
  connection: local
  sudo: false
  register: cluster_uuid

- name: Read cluster UUID if it already exists
  command: cat fetch/ceph_cluster_uuid.conf removes=fetch/ceph_cluster_uuid.conf
  connection: local
  sudo: false
  register: cluster_uuid

- name: Generate Ceph configuration file
  template: >
    src=ceph.conf.j2
    dest=/etc/ceph/ceph.conf
    owner=root
    group=root
    mode=0644
  notify:
    - restart ceph
    - restart ceph-osd-all on ubuntu

- name: Disable OSD directory parsing by updatedb
  command: updatedb -e /var/lib/ceph
  ignore_errors: true

- name: Increase PID max value to a very large value
  sysctl: >
    name="kernel.pid_max"
    value=4194303
    state=present
    sysctl_file=/etc/sysctl.conf
